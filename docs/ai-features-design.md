# Dazzle AI åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## 1. æ¦‚è¿°

ä¸º Dazzle å¢åŠ ä¸‰é¡¹ AI é©±åŠ¨çš„å‰ç«¯èƒ½åŠ›ï¼š

| åŠŸèƒ½ | å…¥å£ | è¯´æ˜ |
|------|------|------|
| **è‡ªç„¶è¯­è¨€è®°è´¦** | QuickEntry é¡µé¢ | ç”¨æˆ·ç”¨è‡ªç„¶è¯­è¨€æè¿°äº¤æ˜“ï¼ŒAI è§£æä¸ºç»“æ„åŒ–æ•°æ®å¡«å…¥è¡¨å• |
| **æ™ºèƒ½ BQL æŸ¥è¯¢** | æ–°å¢é¡µé¢æˆ– Analytics å†…åµŒ | ç”¨æˆ·ç”¨è‡ªç„¶è¯­è¨€æé—®ï¼ŒAI ç”Ÿæˆ BQL æŸ¥è¯¢å¹¶å±•ç¤ºç»“æœ |
| **AI è´¢åŠ¡æ´å¯Ÿ** | Dashboard å†…åµŒå¡ç‰‡ | åŸºäºå½“å‰è´¢åŠ¡æ•°æ®ï¼ŒAI ç”Ÿæˆä¸ªæ€§åŒ–åˆ†ææ‘˜è¦ |

### 1.1 æ ¸å¿ƒçº¦æŸ

1. **ä»…ä½¿ç”¨å·²æœ‰è´¦æˆ·/åˆ†ç±»** â€” AI è¾“å‡ºçš„ `account`ã€`tag`ã€`currency` å¿…é¡»ä» `ledgerData` ä¸­å·²æœ‰å€¼é€‰å–ï¼Œä¸å…è®¸ç”Ÿæˆä»»ä½•æ–°å€¼ã€‚`payee` ä¼˜å…ˆä»å·²æœ‰åˆ—è¡¨åŒ¹é…ï¼Œæ‰¾ä¸åˆ°æ—¶å…è®¸ä½¿ç”¨æ–°å€¼ã€‚Prompt ä¸­æ˜¾å¼æ³¨å…¥å¯é€‰å€¼åˆ—è¡¨ä½œä¸ºçº¦æŸã€‚
2. **æ—¶é—´ç”±å®¢æˆ·ç«¯æ§åˆ¶** â€” æ—¥æœŸ/æ—¶é—´åœ¨å‰ç«¯ç”¨ `new Date()` è·å–åæ³¨å…¥ promptï¼ŒLLM è¿”å›çš„æ—¥æœŸä»…å…è®¸ä¸ºç›¸å¯¹è¡¨è¾¾ï¼ˆ"æ˜¨å¤©""ä¸Šå‘¨äº”"ï¼‰ç”±å‰ç«¯è§£æï¼Œæˆ–ç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯æ³¨å…¥çš„æ—¥æœŸã€‚ç»ä¸ä¿¡ä»» LLM è‡ªè¡Œç”Ÿæˆçš„ç»å¯¹æ—¥æœŸã€‚
3. **çº¯å‰ç«¯å®ç°** â€” æ‰€æœ‰ AI è°ƒç”¨åœ¨æµè§ˆå™¨ç«¯ç›´æ¥è¯·æ±‚ LLM APIï¼Œä¸æ–°å¢åç«¯ä»£ç ã€‚

---

## 2. AI æœåŠ¡å±‚è®¾è®¡

### 2.1 æ–°å¢æ–‡ä»¶ç»“æ„

```
src/
  lib/
    ai.ts              # AI æœåŠ¡æ ¸å¿ƒï¼šAPI è°ƒç”¨ã€prompt æ„é€ ã€å“åº”è§£æ
  stores/
    ai.ts              # AI é…ç½®çŠ¶æ€ï¼ˆproviderã€apiKeyã€modelï¼‰
  pages/
    Settings.tsx        # æ‰©å±•ï¼šæ–°å¢ AI é…ç½®åŒºåŸŸ
    QuickEntry.tsx      # æ‰©å±•ï¼šæ–°å¢è‡ªç„¶è¯­è¨€è¾“å…¥
    SmartQuery.tsx      # æ–°å¢é¡µé¢ï¼šæ™ºèƒ½æŸ¥è¯¢
  components/
    AIInsightCard.tsx   # Dashboard ç”¨çš„ AI æ´å¯Ÿå¡ç‰‡
```

### 2.2 é…ç½®æ¥æºä¸ä¼˜å…ˆçº§ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰

AI é…ç½®æ”¯æŒä¸‰å±‚æ¥æºï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

```
Settings UIï¼ˆlocalStorageï¼‰  >  ç¯å¢ƒå˜é‡ï¼ˆæ„å»ºæ—¶æ³¨å…¥ï¼‰  >  å†…ç½®é»˜è®¤å€¼
```

| é…ç½®é¡¹ | ç¯å¢ƒå˜é‡ | å†…ç½®é»˜è®¤å€¼ | Settings UI |
|--------|---------|-----------|-------------|
| Base URL | `VITE_AI_BASE_URL` | `https://api.openai.com/v1` | âœ… å¯è¦†ç›– |
| Model | `VITE_AI_MODEL` | `gpt-4o-mini` | âœ… å¯è¦†ç›– |
| API Key | `VITE_AI_API_KEY` | æ—  | âœ… å¯è¦†ç›– |

ä¸‰è€…å¤„ç†æ–¹å¼å®Œå…¨ä¸€è‡´ï¼šç¯å¢ƒå˜é‡æä¾›é»˜è®¤å€¼ï¼ŒSettings UI å¯è¦†ç›–ã€‚

> âš ï¸ **å®‰å…¨æç¤º**ï¼š`VITE_` å‰ç¼€çš„ç¯å¢ƒå˜é‡ä¼šè¢« Vite æ‰“åŒ…è¿› JS äº§ç‰©ï¼Œåœ¨æµè§ˆå™¨ç«¯å¯è§ã€‚é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½® API Key é€‚ç”¨äºæœ¬åœ°å¼€å‘å’Œä¸ªäººè‡ªéƒ¨ç½²åœºæ™¯ã€‚å¤šç”¨æˆ·å…±äº«éƒ¨ç½²æ—¶ï¼Œå»ºè®®ä¸è®¾ç½® `VITE_AI_API_KEY`ï¼Œè®©æ¯ä¸ªç”¨æˆ·åœ¨ Settings ä¸­è‡ªè¡Œå¡«å†™ã€‚

å…¸å‹éƒ¨ç½²åœºæ™¯ï¼š
- **æœ¬åœ°å¼€å‘/æµ‹è¯•**ï¼šåœ¨ `.env.local` ä¸­é…ç½®å…¨éƒ¨ä¸‰é¡¹ï¼Œæ‰“å¼€å³å¯ç”¨ï¼Œæ— éœ€è¿› Settings é¡µé¢ã€‚
- **ä¸ªäººè‡ªéƒ¨ç½²ï¼ˆDockerï¼‰**ï¼š`.env` æˆ– `docker-compose.yml` é¢„è®¾å…¨éƒ¨ä¸‰é¡¹ï¼Œä¸€æ¬¡é…ç½®é•¿æœŸä½¿ç”¨ã€‚
- **å¤šç”¨æˆ·å…±äº«éƒ¨ç½²**ï¼šä»…é¢„è®¾ `VITE_AI_BASE_URL` å’Œ `VITE_AI_MODEL`ï¼ŒAPI Key ç”±æ¯ä¸ªç”¨æˆ·åœ¨ Settings ä¸­è‡ªè¡Œå¡«å†™ã€‚

### 2.3 AI é…ç½® Store â€” `src/stores/ai.ts`

```typescript
// ç¯å¢ƒå˜é‡è¯»å–ï¼ˆæ„å»ºæ—¶æ³¨å…¥ï¼‰
const ENV_DEFAULTS = {
  apiKey: import.meta.env.VITE_AI_API_KEY || '',
  baseUrl: import.meta.env.VITE_AI_BASE_URL || 'https://api.openai.com/v1',
  model: import.meta.env.VITE_AI_MODEL || 'gpt-4o-mini',
};

interface AIConfig {
  apiKey: string;            // localStorage > VITE_AI_API_KEY
  baseUrl: string;           // localStorage > VITE_AI_BASE_URL > é»˜è®¤å€¼
  model: string;             // localStorage > VITE_AI_MODEL > é»˜è®¤å€¼
}

interface AIState {
  config: AIConfig;
  setConfig: (config: Partial<AIConfig>) => void;
  isConfigured: () => boolean;   // è‡³å°‘éœ€è¦ apiKey æ‰ç®—å·²é…ç½®
  getEffectiveConfig: () => AIConfig;  // åˆå¹¶ä¸‰å±‚æ¥æºåçš„æœ€ç»ˆé…ç½®
}
```

é…ç½®åˆå¹¶é€»è¾‘ï¼š

```typescript
function getEffectiveConfig(): AIConfig {
  const stored = JSON.parse(localStorage.getItem('dazzle-ai-config') || '{}');
  return {
    apiKey: stored.apiKey || ENV_DEFAULTS.apiKey,
    baseUrl: stored.baseUrl || ENV_DEFAULTS.baseUrl,
    model: stored.model || ENV_DEFAULTS.model,
  };
}
```

- `isConfigured()` åˆ¤æ–­æ¡ä»¶ï¼š`apiKey` éç©º
- Settings UI ä¸­ï¼ŒBase URL å’Œ Model è¾“å…¥æ¡†æ˜¾ç¤º placeholder ä¸ºç¯å¢ƒå˜é‡å€¼æˆ–å†…ç½®é»˜è®¤å€¼ï¼Œç”¨æˆ·ç•™ç©ºå³ä½¿ç”¨é»˜è®¤å€¼
- `apiKey` ä»…å­˜ `localStorage`ï¼Œä¸ä¼ è¾“åˆ°é™¤ LLM API å¤–çš„ä»»ä½•åœ°æ–¹

### 2.4 AI æœåŠ¡æ ¸å¿ƒ â€” `src/lib/ai.ts`

```typescript
// æ ¸å¿ƒè°ƒç”¨å‡½æ•°
async function chatCompletion(
  messages: Array<{ role: 'system' | 'user'; content: string }>,
  config: AIConfig,
  options?: { temperature?: number; response_format?: { type: string } }
): Promise<string>

// æ„é€ è´¦æœ¬ä¸Šä¸‹æ–‡ï¼ˆæ³¨å…¥åˆ° system promptï¼‰
function buildLedgerContext(ledgerData: LedgerData): string

// ä¸‰ä¸ªå…·ä½“åŠŸèƒ½çš„å…¥å£
function parseNaturalEntry(input: string, ledgerData: LedgerData, clientDate: string): Promise<ParsedEntry>
function generateBQL(question: string, ledgerData: LedgerData): Promise<string>
function generateInsights(financialData: FinancialSummary, ledgerData: LedgerData): Promise<string>
```

---

## 3. åŠŸèƒ½ä¸€ï¼šè‡ªç„¶è¯­è¨€è®°è´¦

### 3.1 ç”¨æˆ·æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "æ˜¨å¤©åœ¨æ˜Ÿå·´å…‹èŠ±äº†38å…ƒä¹°å’–å•¡"
    â†“
å‰ç«¯è·å– clientNow = new Date() â†’ "2026-02-20"
    â†“
æ„é€  promptï¼ˆåŒ…å«è´¦æˆ·åˆ—è¡¨ã€payee åˆ—è¡¨ã€å½“å‰æ—¥æœŸï¼‰
    â†“
LLM è¿”å› JSON
    â†“
å‰ç«¯æ ¡éªŒï¼šaccount âˆˆ ledgerData.accounts, payee âˆˆ ledgerData.payees
    â†“
å¡«å……åˆ° QuickEntry è¡¨å•ï¼ˆç”¨æˆ·å¯ä¿®æ”¹åæäº¤ï¼‰
```

### 3.2 Prompt è®¾è®¡

```
System Prompt:
ä½ æ˜¯ä¸€ä¸ªè®°è´¦åŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°ï¼Œè§£æå‡ºç»“æ„åŒ–çš„äº¤æ˜“ä¿¡æ¯ã€‚

## ä¸¥æ ¼çº¦æŸ
- å½“å‰æ—¥æœŸï¼š{clientDate}ï¼ˆæ ¼å¼ YYYY-MM-DDï¼‰
- ä½ åªèƒ½ä½¿ç”¨ä»¥ä¸‹å·²å­˜åœ¨çš„ä¿¡æ¯ï¼Œä¸å¯ç¼–é€ æ–°çš„è´¦æˆ·ã€æ”¶æ¬¾æ–¹æˆ–æ ‡ç­¾

## å¯ç”¨è´¦æˆ·åˆ—è¡¨
{accountsï¼ˆæŒ‰å‰ç¼€åˆ†ç»„ï¼Œå¦‚ Expenses:Food:*, Assets:Bank:* ç­‰ï¼‰}

## å¯ç”¨æ”¶æ¬¾æ–¹
{payees}

## å¯ç”¨æ ‡ç­¾
{tags}

## ä¸»è¦è´§å¸
{operating_currency}

## è¾“å‡ºæ ¼å¼
å¿…é¡»è¿”å›å¦‚ä¸‹ JSONï¼Œä¸è¦åŒ…å«å…¶ä»–å†…å®¹ï¼š
{
  "date": "YYYY-MM-DDï¼ˆåŸºäºå½“å‰æ—¥æœŸè®¡ç®—ï¼Œå¦‚'æ˜¨å¤©'= å½“å‰æ—¥æœŸ-1å¤©ï¼‰",
  "payee": "ä»å¯ç”¨æ”¶æ¬¾æ–¹åˆ—è¡¨ä¸­åŒ¹é…ï¼Œæ— åŒ¹é…åˆ™ä¸º null",
  "narration": "äº¤æ˜“æè¿°",
  "tags": ["ä»å¯ç”¨æ ‡ç­¾ä¸­åŒ¹é…ï¼Œæ— åŒ¹é…åˆ™ä¸ºç©ºæ•°ç»„"],
  "postings": [
    { "account": "å¿…é¡»æ¥è‡ªå¯ç”¨è´¦æˆ·åˆ—è¡¨", "amount": "æ•°å€¼å­—ç¬¦ä¸²", "currency": "è´§å¸" },
    { "account": "å¿…é¡»æ¥è‡ªå¯ç”¨è´¦æˆ·åˆ—è¡¨", "amount": "", "currency": "è´§å¸" }
  ]
}
```

### 3.3 å‰ç«¯æ—¥æœŸè§£æç­–ç•¥ï¼ˆé˜² LLM æ±¡æŸ“ï¼‰

```typescript
function resolveDate(llmDate: string, clientDate: string): string {
  const client = new Date(clientDate);
  const llm = new Date(llmDate);

  // å¦‚æœ LLM è¿”å›çš„æ—¥æœŸä¸å®¢æˆ·ç«¯æ—¥æœŸå·®è·è¶…è¿‡ 365 å¤©ï¼Œè§†ä¸ºå¼‚å¸¸ï¼Œå›é€€åˆ°å®¢æˆ·ç«¯æ—¥æœŸ
  const diffDays = Math.abs((llm.getTime() - client.getTime()) / 86400000);
  if (isNaN(llm.getTime()) || diffDays > 365) {
    return clientDate;
  }

  return llmDate;
}
```

å…³é”®ç‚¹ï¼š
- `clientDate` åœ¨è°ƒç”¨ AI **ä¹‹å‰**ç”± `new Date().toISOString().slice(0, 10)` ç”Ÿæˆ
- LLM çš„ system prompt ä¸­æ˜¾å¼å†™å…¥ `clientDate`ï¼Œè®©æ¨¡å‹åŸºäºæ­¤è®¡ç®—ç›¸å¯¹æ—¥æœŸ
- å‰ç«¯å¯¹ LLM è¿”å›çš„æ—¥æœŸåšåˆç†æ€§æ ¡éªŒï¼ˆä¸è¶…è¿‡ Â±365 å¤©èŒƒå›´ï¼‰ï¼Œå¼‚å¸¸æ—¶å›é€€

### 3.4 å“åº”æ ¡éªŒé€»è¾‘

```typescript
function validateParsedEntry(entry: ParsedEntry, ledgerData: LedgerData): ValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];

  // 1. æ ¡éªŒè´¦æˆ· â€” å¿…é¡»å­˜åœ¨äº ledgerData.accounts
  for (const posting of entry.postings) {
    if (!ledgerData.accounts.includes(posting.account)) {
      // å°è¯•æ¨¡ç³ŠåŒ¹é…æœ€è¿‘çš„è´¦æˆ·
      const closest = fuzzyMatch(posting.account, ledgerData.accounts);
      if (closest) {
        warnings.push(`è´¦æˆ· "${posting.account}" ä¸å­˜åœ¨ï¼Œå·²ä¿®æ­£ä¸º "${closest}"`);
        posting.account = closest;
      } else {
        errors.push(`è´¦æˆ· "${posting.account}" ä¸å­˜åœ¨`);
      }
    }
  }

  // 2. æ ¡éªŒè´§å¸
  for (const posting of entry.postings) {
    if (!ledgerData.currencies.includes(posting.currency)) {
      posting.currency = ledgerData.options.operating_currency[0];
      warnings.push(`è´§å¸å·²ä¿®æ­£ä¸º ${posting.currency}`);
    }
  }

  // 3. æ ¡éªŒ payeeï¼ˆå…è®¸ä¸º nullï¼Œä½†å¦‚æœæœ‰å€¼å¿…é¡»åœ¨åˆ—è¡¨ä¸­æˆ–å‘å‡ºè­¦å‘Šï¼‰
  if (entry.payee && !ledgerData.payees.includes(entry.payee)) {
    warnings.push(`æ”¶æ¬¾æ–¹ "${entry.payee}" ä¸åœ¨å·²çŸ¥åˆ—è¡¨ä¸­ï¼Œå°†ä½œä¸ºæ–°æ”¶æ¬¾æ–¹`);
  }

  // 4. æ ¡éªŒ tags
  entry.tags = entry.tags.filter(t => ledgerData.tags.includes(t));

  return { valid: errors.length === 0, errors, warnings, entry };
}
```

### 3.5 UI æ”¹åŠ¨ â€” QuickEntry é¡µé¢

åœ¨ç°æœ‰è¡¨å•**ä¸Šæ–¹**å¢åŠ ä¸€ä¸ªè‡ªç„¶è¯­è¨€è¾“å…¥åŒºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– AI å¿«é€Ÿè®°è´¦                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”â”‚
â”‚ â”‚ æ˜¨å¤©åœ¨æ˜Ÿå·´å…‹èŠ±äº†38å…ƒä¹°å’–å•¡       â”‚ â”‚ğŸ”â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚ ï¼ˆè§£æç»“æœé¢„è§ˆ â€” å¯ç¼–è¾‘ï¼Œç¡®è®¤åå¡«å…¥è¡¨å•ï¼‰   â”‚
â”‚ æ—¥æœŸ: 2026-02-19  æ”¶æ¬¾æ–¹: æ˜Ÿå·´å…‹          â”‚
â”‚ æè¿°: å’–å•¡                               â”‚
â”‚ Expenses:Food:Coffee  38.00 CNY          â”‚
â”‚ Assets:Bank:CMB       (è‡ªåŠ¨)              â”‚
â”‚ âš ï¸ è­¦å‘Š: è´¦æˆ· "Expenses:Food:Cafe"       â”‚
â”‚    ä¸å­˜åœ¨ï¼Œå·²ä¿®æ­£ä¸º "Expenses:Food:Coffee" â”‚
â”‚                                         â”‚
â”‚             [å¡«å…¥è¡¨å•]  [é‡æ–°è§£æ]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ åŸæœ‰æ‰‹åŠ¨è¡¨å• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ...ï¼ˆç°æœ‰çš„ QuickEntry è¡¨å•ä¿æŒä¸å˜ï¼‰...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æµç¨‹ï¼š
1. ç”¨æˆ·åœ¨ AI è¾“å…¥æ¡†è¾“å…¥è‡ªç„¶è¯­è¨€ â†’ ç‚¹å‡»è§£æï¼ˆæˆ– Enterï¼‰
2. æ˜¾ç¤ºè§£æç»“æœé¢„è§ˆï¼ˆå«è­¦å‘Šï¼‰â†’ ç”¨æˆ·å¯åœ¨é¢„è§ˆä¸­ä¿®æ”¹
3. ç‚¹å‡»ã€Œå¡«å…¥è¡¨å•ã€â†’ æ•°æ®æ³¨å…¥åˆ°ä¸‹æ–¹å·²æœ‰è¡¨å•
4. ç”¨æˆ·åœ¨å·²æœ‰è¡¨å•ä¸­ç¡®è®¤/å¾®è°ƒ â†’ æäº¤

---

## 4. åŠŸèƒ½äºŒï¼šæ™ºèƒ½ BQL æŸ¥è¯¢

### 4.1 ç”¨æˆ·æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "ä»Šå¹´åœ¨æ—…è¡Œä¸ŠèŠ±äº†å¤šå°‘é’±"
    â†“
æ„é€  promptï¼ˆåŒ…å«è´¦æˆ·ç»“æ„ã€BQL è¯­æ³•è¯´æ˜ï¼‰
    â†“
LLM è¿”å› BQL è¯­å¥
    â†“
å‰ç«¯æ ¡éªŒ BQL ä¸­çš„è´¦æˆ·åå­˜åœ¨ â†’ è°ƒç”¨ api.getQuery(bql) æ‰§è¡Œ
    â†“
å±•ç¤ºæŸ¥è¯¢ç»“æœï¼ˆè¡¨æ ¼æˆ–æ–‡æœ¬ï¼‰
```

### 4.2 Prompt è®¾è®¡

```
System Prompt:
ä½ æ˜¯ä¸€ä¸ª Beancount BQL æŸ¥è¯¢ä¸“å®¶ã€‚æ ¹æ®ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€é—®é¢˜ç”Ÿæˆ BQL æŸ¥è¯¢è¯­å¥ã€‚

## å½“å‰æ—¥æœŸ
{clientDate}

## BQL è¯­æ³•è¦ç‚¹
- SELECT ... WHERE ... GROUP BY ... ORDER BY ...
- å¯ç”¨å‡½æ•°: SUM(), COUNT(), CONVERT(position, 'CNY'), YEAR(), MONTH()
- è´¦æˆ·è¿‡æ»¤: account ~ '^Expenses:'ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰
- æ—¥æœŸè¿‡æ»¤: date >= 2026-01-01, year = 2026
- æ ‡ç­¾è¿‡æ»¤: 'tag_name' IN tags
- æ”¶æ¬¾æ–¹è¿‡æ»¤: payee = 'æ˜Ÿå·´å…‹'

## è´¦æˆ·ç»“æ„ï¼ˆå‰ä¸¤çº§ï¼‰
{accountTree â€” å¦‚ Expenses:Food, Expenses:Transport, Assets:Bank, ...}

## å¯ç”¨æ ‡ç­¾
{tags}

## å¯ç”¨æ”¶æ¬¾æ–¹
{payees}

## ä¸»è¦è´§å¸
{operating_currency}

## è¾“å‡ºæ ¼å¼
åªè¿”å›ä¸€æ¡ BQL è¯­å¥ï¼Œä¸è¦åŒ…å«å…¶ä»–å†…å®¹ã€‚
```

### 4.3 BQL å®‰å…¨æ ¡éªŒ

```typescript
function validateBQL(bql: string): { safe: boolean; reason?: string } {
  const upper = bql.toUpperCase().trim();

  // 1. åªå…è®¸ SELECT è¯­å¥
  if (!upper.startsWith('SELECT')) {
    return { safe: false, reason: 'ä»…å…è®¸ SELECT æŸ¥è¯¢' };
  }

  // 2. ç¦æ­¢å±é™©å…³é”®è¯
  const forbidden = ['INSERT', 'UPDATE', 'DELETE', 'DROP', 'ALTER', 'CREATE'];
  for (const keyword of forbidden) {
    if (upper.includes(keyword)) {
      return { safe: false, reason: `åŒ…å«ç¦æ­¢çš„å…³é”®è¯: ${keyword}` };
    }
  }

  return { safe: true };
}
```

æ³¨ï¼šBQL æœ¬èº«æ˜¯åªè¯»æŸ¥è¯¢è¯­è¨€ï¼ˆBeancount ä¸æ”¯æŒå†™æ“ä½œï¼‰ï¼Œæ­¤æ ¡éªŒä¸ºé˜²å¾¡æ€§æªæ–½ã€‚

### 4.4 æ–°å¢é¡µé¢ â€” SmartQuery

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” æ™ºèƒ½æŸ¥è¯¢                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”â”‚
â”‚ â”‚ ä»Šå¹´æ¯ä¸ªæœˆçš„é¤é¥®æ”¯å‡ºæ˜¯å¤šå°‘ï¼Ÿ      â”‚ â”‚ğŸ”â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚ ç”Ÿæˆçš„ BQL:                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ SELECT month, CONVERT(SUM(position),â”‚ â”‚
â”‚ â”‚ 'CNY') WHERE account ~ '^Expenses:  â”‚ â”‚
â”‚ â”‚ Food' AND year = 2026 GROUP BY monthâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             [æ‰§è¡ŒæŸ¥è¯¢]  [ç¼–è¾‘ BQL]       â”‚
â”‚                                         â”‚
â”‚ æŸ¥è¯¢ç»“æœ:                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ month    â”‚ value    â”‚                 â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚ â”‚ 1        â”‚ 3,200.00 â”‚                 â”‚
â”‚ â”‚ 2        â”‚ 2,850.00 â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è·¯ç”±ï¼š`/:ledger/smart-query`ï¼Œæ·»åŠ åˆ° Layout navItemsã€‚

---

## 5. åŠŸèƒ½ä¸‰ï¼šAI è´¢åŠ¡æ´å¯Ÿ

### 5.1 æ•°æ®å‡†å¤‡

ä» Dashboard å·²æœ‰æ•°æ®ä¸­æå–æ‘˜è¦ï¼Œä¸é¢å¤–è¯·æ±‚ APIï¼š

```typescript
interface FinancialSummary {
  netWorth: number;
  totalAssets: number;
  totalLiabilities: number;
  totalIncome: number;
  totalExpenses: number;
  surplus: number;
  currency: string;
  // æœˆåº¦è¶‹åŠ¿ï¼ˆæœ€è¿‘ 6 ä¸ªæœˆï¼‰
  monthlyTrend: Array<{ month: string; income: number; expense: number }>;
  // æ”¯å‡ºå‰ 5 åˆ†ç±»
  topExpenseCategories: Array<{ category: string; amount: number }>;
}
```

### 5.2 Prompt è®¾è®¡

```
System Prompt:
ä½ æ˜¯ä¸€ä¸ªä¸ªäººè´¢åŠ¡åˆ†æå¸ˆã€‚åŸºäºä»¥ä¸‹è´¢åŠ¡æ•°æ®ï¼Œç»™å‡º 3-5 æ¡ç®€æ´çš„æ´å¯Ÿå»ºè®®ã€‚

## å½“å‰æ—¥æœŸ
{clientDate}

## è¦æ±‚
- ä½¿ç”¨ä¸­æ–‡
- æ¯æ¡æ´å¯Ÿä¸€å¥è¯ï¼Œé™„å¸¦å…·ä½“æ•°æ®
- å…³æ³¨è¶‹åŠ¿å˜åŒ–ã€å¼‚å¸¸æ”¯å‡ºã€å‚¨è“„ç‡ç­‰
- ä¸è¦ç»™å‡ºæŠ•èµ„å»ºè®®
- ä¸è¦ç¼–é€ ä¸åœ¨æ•°æ®ä¸­çš„ä¿¡æ¯

## è´¢åŠ¡æ•°æ®
{financialSummary as JSON}

## è¾“å‡ºæ ¼å¼
è¿”å› JSON æ•°ç»„ï¼š
[
  { "icon": "ğŸ“ˆ|ğŸ“‰|ğŸ’¡|âš ï¸|âœ…", "text": "æ´å¯Ÿå†…å®¹" }
]
```

### 5.3 UI â€” Dashboard å†…åµŒ

åœ¨ Dashboard ç°æœ‰æŒ‡æ ‡å¡ç‰‡ä¸‹æ–¹ã€å›¾è¡¨ä¸Šæ–¹æ’å…¥ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ AI æ´å¯Ÿ                    [åˆ·æ–°]     â”‚
â”‚                                         â”‚
â”‚ ğŸ“ˆ æœ¬æœˆæ”¶å…¥è¾ƒä¸Šæœˆå¢é•¿ 12%ï¼Œä¸»è¦æ¥è‡ªå·¥èµ„   â”‚
â”‚ âš ï¸ é¤é¥®æ”¯å‡ºå æ€»æ”¯å‡º 35%ï¼Œé«˜äºè¿‘6æœˆå‡å€¼    â”‚
â”‚ âœ… å‚¨è“„ç‡ 28%ï¼Œä¿æŒå¥åº·æ°´å¹³              â”‚
â”‚ ğŸ“‰ äº¤é€šæ”¯å‡ºè¿ç»­3ä¸ªæœˆä¸Šå‡ï¼Œå»ºè®®å…³æ³¨        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ä»…åœ¨ AI å·²é…ç½®æ—¶æ˜¾ç¤ºæ­¤å¡ç‰‡
- ç»“æœç¼“å­˜åˆ° `sessionStorage`ï¼Œé¿å…é‡å¤è°ƒç”¨
- æä¾›æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®

---

## 6. è´¦æœ¬ä¸Šä¸‹æ–‡æ„é€ ç­–ç•¥

### 6.1 ä¸Šä¸‹æ–‡è£å‰ª

`ledgerData` å¯èƒ½åŒ…å«å¤§é‡è´¦æˆ·ï¼ˆæ•°ç™¾ä¸ªï¼‰ï¼Œéœ€è¦è£å‰ªä»¥æ§åˆ¶ token ç”¨é‡ï¼š

```typescript
function buildLedgerContext(ledgerData: LedgerData, feature: 'entry' | 'query' | 'insight'): string {
  const sections: string[] = [];

  // 1. åŸºæœ¬ä¿¡æ¯
  sections.push(`ä¸»è¦è´§å¸: ${ledgerData.options.operating_currency.join(', ')}`);

  // 2. è´¦æˆ·åˆ—è¡¨ â€” æŒ‰å‰ç¼€åˆ†ç»„ï¼Œæ¯ç»„æœ€å¤šå±•ç¤ºå®Œæ•´è·¯å¾„
  //    å¯¹ entry åŠŸèƒ½ï¼šå…¨é‡ä¼ å…¥ï¼ˆç¡®ä¿åŒ¹é…å‡†ç¡®ï¼‰
  //    å¯¹ query/insight åŠŸèƒ½ï¼šä»…ä¼ å‰ä¸¤çº§ï¼ˆå‡å°‘ tokenï¼‰
  const accounts = feature === 'entry'
    ? ledgerData.accounts
    : deduplicateByPrefix(ledgerData.accounts, 2);
  sections.push(`å¯ç”¨è´¦æˆ·:\n${accounts.join('\n')}`);

  // 3. æ”¶æ¬¾æ–¹ â€” entry å…¨é‡ï¼Œå…¶ä»–ç²¾ç®€
  if (feature === 'entry') {
    sections.push(`å¯ç”¨æ”¶æ¬¾æ–¹:\n${ledgerData.payees.join(', ')}`);
  }

  // 4. æ ‡ç­¾
  if (ledgerData.tags.length > 0) {
    sections.push(`å¯ç”¨æ ‡ç­¾: ${ledgerData.tags.join(', ')}`);
  }

  // 5. å¯ç”¨è´§å¸
  sections.push(`å¯ç”¨è´§å¸: ${ledgerData.currencies.slice(0, 20).join(', ')}`);

  return sections.join('\n\n');
}

// æŒ‰å‰ç¼€å»é‡ï¼Œä¿ç•™å‰ N çº§
function deduplicateByPrefix(accounts: string[], levels: number): string[] {
  const seen = new Set<string>();
  return accounts.filter(a => {
    const prefix = a.split(':').slice(0, levels).join(':');
    if (seen.has(prefix)) return false;
    seen.add(prefix);
    return true;
  });
}
```

### 6.2 Token é¢„ç®—ä¼°ç®—

| åŠŸèƒ½ | System Prompt | è´¦æˆ·ä¸Šä¸‹æ–‡ | ç”¨æˆ·è¾“å…¥ | é¢„è®¡æ€» token |
|------|-------------|----------|---------|------------|
| è‡ªç„¶è¯­è¨€è®°è´¦ | ~300 | ~2000ï¼ˆå…¨é‡è´¦æˆ·ï¼‰ | ~50 | ~2500 |
| æ™ºèƒ½æŸ¥è¯¢ | ~400 | ~800ï¼ˆç²¾ç®€è´¦æˆ·ï¼‰ | ~50 | ~1300 |
| è´¢åŠ¡æ´å¯Ÿ | ~200 | ~500 | ~500ï¼ˆæ•°æ®ï¼‰ | ~1200 |

ä½¿ç”¨ `gpt-4o-mini` æ—¶ï¼Œå•æ¬¡è°ƒç”¨æˆæœ¬çº¦ $0.001 ä»¥å†…ã€‚

---

## 7. Settings é¡µé¢æ‰©å±•

åœ¨ç°æœ‰ Settings é¡µé¢å¢åŠ  AI é…ç½®å¡ç‰‡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI è®¾ç½®                                               â”‚
â”‚                                                      â”‚
â”‚ API Key    [sk-â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢]              [æ˜¾ç¤º/éšè—]  â”‚
â”‚                                                      â”‚
â”‚ Base URL   [                                       ]  â”‚
â”‚            placeholder: https://api.openai.com/v1     â”‚
â”‚            (æ¥è‡ªç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤)           â”‚
â”‚                                                      â”‚
â”‚ æ¨¡å‹       [                                       ]  â”‚
â”‚            placeholder: gpt-4o-mini                   â”‚
â”‚            (æ¥è‡ªç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤)           â”‚
â”‚                                                      â”‚
â”‚ [æµ‹è¯•è¿æ¥]                                            â”‚
â”‚ âœ… è¿æ¥æˆåŠŸï¼Œæ¨¡å‹: gpt-4o-mini                         â”‚
â”‚                                                      â”‚
â”‚ å½“å‰ç”Ÿæ•ˆé…ç½®:                                          â”‚
â”‚   Base URL: https://api.openai.com/v1 (ç¯å¢ƒå˜é‡)       â”‚
â”‚   Model: gpt-4o-mini (å†…ç½®é»˜è®¤)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- API Key ä½¿ç”¨ `type="password"` è¾“å…¥ï¼Œæ˜¯å”¯ä¸€å¿…å¡«é¡¹
- Base URL å’Œ Model ç•™ç©ºæ—¶è‡ªåŠ¨ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å†…ç½®é»˜è®¤å€¼ï¼Œplaceholder å±•ç¤ºå½“å‰é»˜è®¤å€¼æ¥æº
- åº•éƒ¨ã€Œå½“å‰ç”Ÿæ•ˆé…ç½®ã€æ˜¾ç¤ºæœ€ç»ˆåˆå¹¶åçš„å€¼åŠå…¶æ¥æºï¼ˆç”¨æˆ·è®¾ç½® / ç¯å¢ƒå˜é‡ / å†…ç½®é»˜è®¤ï¼‰
- æä¾›ã€Œæµ‹è¯•è¿æ¥ã€åŠŸèƒ½ï¼šå‘é€ç®€å• prompt éªŒè¯é…ç½®æœ‰æ•ˆæ€§
- ç”¨æˆ·è®¾ç½®çš„å€¼å­˜ `localStorage`ï¼ˆkey: `dazzle-ai-config`ï¼‰ï¼ŒAPI Key ä¸é€šè¿‡ç¯å¢ƒå˜é‡

---

## 8. å®ç°ä¼˜å…ˆçº§ä¸æ­¥éª¤

### Phase 1ï¼šåŸºç¡€è®¾æ–½
1. åˆ›å»º `src/stores/ai.ts` â€” AI é…ç½® store
2. åˆ›å»º `src/lib/ai.ts` â€” AI æœåŠ¡å±‚ï¼ˆchatCompletionã€buildLedgerContextï¼‰
3. æ‰©å±• Settings é¡µé¢ â€” AI é…ç½® UI

### Phase 2ï¼šè‡ªç„¶è¯­è¨€è®°è´¦
4. å®ç° `parseNaturalEntry()` å’Œæ—¥æœŸæ ¡éªŒã€å“åº”æ ¡éªŒé€»è¾‘
5. åœ¨ QuickEntry é¡µé¢æ·»åŠ  AI è¾“å…¥åŒºå’Œè§£æé¢„è§ˆ UI
6. æ¥å…¥å·²æœ‰è¡¨å•çš„å¡«å……é€»è¾‘

### Phase 3ï¼šæ™ºèƒ½ BQL æŸ¥è¯¢
7. å®ç° `generateBQL()` å’Œ BQL å®‰å…¨æ ¡éªŒ
8. åˆ›å»º SmartQuery é¡µé¢
9. æ³¨å†Œè·¯ç”±ï¼Œæ·»åŠ å¯¼èˆªå…¥å£

### Phase 4ï¼šAI è´¢åŠ¡æ´å¯Ÿ
10. å®ç° `generateInsights()` å’Œæ•°æ®æ‘˜è¦æå–
11. åˆ›å»º AIInsightCard ç»„ä»¶
12. åµŒå…¥ Dashboard é¡µé¢

---

## 9. å®‰å…¨è€ƒè™‘

| é£é™© | ç¼“è§£æªæ–½ |
|------|---------|
| API Key æ³„éœ² | `VITE_AI_API_KEY` ç¯å¢ƒå˜é‡ä»…å»ºè®®ç”¨äºæœ¬åœ°å¼€å‘/ä¸ªäººéƒ¨ç½²ï¼ˆä¼šæ‰“åŒ…è¿› JS äº§ç‰©ï¼‰ï¼›Settings UI ä½¿ç”¨ password è¾“å…¥ï¼›ä¸ä¼ è¾“åˆ° Fava åç«¯ |
| Prompt æ³¨å…¥ | ç”¨æˆ·è¾“å…¥æ”¾åœ¨ user message ä¸­ï¼Œä¸æ‹¼æ¥è¿› system promptï¼›å¯¹ BQL åšç™½åå•æ ¡éªŒ |
| LLM å¹»è§‰ï¼ˆç¼–é€ è´¦æˆ·ï¼‰ | å‰ç«¯å¼ºæ ¡éªŒï¼šaccount âˆˆ accountsï¼Œä¸å­˜åœ¨åˆ™æ¨¡ç³ŠåŒ¹é…æˆ–æ‹’ç» |
| LLM å¹»è§‰ï¼ˆæ—¥æœŸé”™è¯¯ï¼‰ | clientDate å‰ç«¯ç”Ÿæˆå¹¶æ³¨å…¥ï¼Œè¿”å›å€¼åš Â±365 å¤©åˆç†æ€§æ ¡éªŒ |
| è´¹ç”¨å¤±æ§ | ä½¿ç”¨ä½æˆæœ¬æ¨¡å‹ï¼ˆgpt-4o-miniï¼‰ï¼›å¯åœ¨è®¾ç½®ä¸­é™åˆ¶è°ƒç”¨é¢‘ç‡ |
